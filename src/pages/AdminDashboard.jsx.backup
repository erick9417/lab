import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import LucvanHeader from '../components/LucvanHeader';
import { apiFetch } from '../lib/api';

// Lista de pa√≠ses de Am√©rica para selecciones de cl√≠nica
const AMERICAS_COUNTRIES = [
  'Argentina',
  'Bahamas',
  'Barbados',
  'Belice',
  'Bolivia',
  'Brasil',
  'Canad√°',
  'Chile',
  'Colombia',
  'Costa Rica',
  'Cuba',
  'Dominica',
  'Ecuador',
  'El Salvador',
  'Estados Unidos',
  'Granada',
  'Guatemala',
  'Guyana',
  'Hait√≠',
  'Honduras',
  'Jamaica',
  'M√©xico',
  'Nicaragua',
  'Panam√°',
  'Paraguay',
  'Per√∫',
  'Rep√∫blica Dominicana',
  'San Crist√≥bal y Nieves',
  'San Vicente y las Granadinas',
  'Santa Luc√≠a',
  'Surinam',
  'Trinidad y Tobago',
  'Uruguay',
  'Venezuela'
]

export default function AdminDashboard() {
  const [activeView, setActiveView] = useState('home')
  const [selectedReport, setSelectedReport] = useState('patients')
  const [backupInProgress, setBackupInProgress] = useState(false)
  const { currentUser, logout } = useAuth()
  const navigate = useNavigate()
  const [showCreateClinic, setShowCreateClinic] = useState(false)
  const [showCreateUser, setShowCreateUser] = useState(false)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState('')

  // API data state
  const [allPatients, setAllPatients] = useState([])
  const [allTickets, setAllTickets] = useState([])
  const [allUsers, setAllUsers] = useState([])
  const [allClinics, setAllClinics] = useState([])
  const [newClinic, setNewClinic] = useState({ name: '', country: '', phone: '', address: '' })
  const [newUser, setNewUser] = useState({ name: '', email: '', role: 'clinic', clinic: '' })

  // Load data from API
  useEffect(() => {
    const loadData = async () => {
      try {
        setLoading(true)
        setError('')

        // Load users
        const usersResponse = await apiFetch('/api/users')
        if (usersResponse.ok) {
          const users = await usersResponse.json()
          setAllUsers(users.map(u => ({
            id: u.id,
            name: u.email.split('@')[0],
            email: u.email,
            role: u.role,
            organization: u.clinic_name || 'Lucv√°n',
            createdAt: new Date().toISOString().split('T')[0] // Placeholder
          })))
        }

        // Load clinics
        const clinicsResponse = await apiFetch('/api/clinics')
        if (clinicsResponse.ok) {
          const clinics = await clinicsResponse.json()
          setAllClinics(clinics)
        }

        // Load requests and patients first to map correctly
        const [requestsResponse, patientsResponse] = await Promise.all([
          apiFetch('/api/requests'),
          apiFetch('/api/patients')
        ])

        let patientMap = {}
        if (patientsResponse.ok) {
          const patients = await patientsResponse.json()
          patientMap = Object.fromEntries(patients.map(p => [p.id, p]))
        }

        if (requestsResponse.ok) {
          const requests = await requestsResponse.json()
          setAllTickets(requests.map(r => {
            const patient = patientMap[r.patient_id]
            const statusMap = {
              'pending': 'Pendiente',
              'in_progress': 'En Producci√≥n',
              'in_production': 'En Producci√≥n',
              'ready': 'Lista para Entregar',
              'delivered': 'Entregada',
              'cancelled': 'Cancelada'
            }
            return {
              id: r.id,
              patientName: patient?.name || `Paciente ${r.patient_id}`,
              clinicName: patient?.clinic || r.clinic_name || 'Sin cl√≠nica',
              doctorName: r.doctor_name || '-',
              templateType: r.template_type || 'Solicitud',
              arch: r.foot_side || '-',
              status: statusMap[r.status] || 'Pendiente',
              date: new Date(r.created_at).toISOString().split('T')[0],
              createdDate: new Date(r.created_at).toISOString().split('T')[0]
            }
          }))
        }

        // Load patients from API (falls back to empty array)
        try {
          const patientsResp = await apiFetch('/api/patients')
          if (patientsResp.ok) {
            const patients = await patientsResp.json()
            // normalize dates if needed
            setAllPatients(patients.map(p => ({
              id: p.id,
              name: p.name,
              phone: p.phone,
              email: p.email,
              birthDate: p.birthDate || p.birth_date || null,
              clinic: p.clinic,
              notes: p.notes
            })))
          } else {
            setAllPatients([])
          }
        } catch (err) {
          console.error('Error loading patients:', err)
          setAllPatients([])
        }

      } catch (err) {
        console.error('Error loading data:', err)
        setError('Error al cargar los datos')
      } finally {
        setLoading(false)
      }
    }

    loadData()
  }, [])

  // Load backup data function
  const loadBackupData = async () => {
    try {
      const response = await apiFetch('/api/backups')
      if (response.ok) {
        const data = await response.json()
        setBackupHistory(data.backups || [])
        setSystemStatus(data.status || {
          lastBackup: null,
          nextBackup: null,
          serverSpace: { used: 0, total: 22, unit: 'GB' },
          cloudSpace: { used: 0, total: 5, unit: 'GB' },
          archiveCount: 0
        })
      }
    } catch (err) {
      console.error('Error loading backup data:', err)
    }
  }

  // Load backups when entering backups view
  useEffect(() => {
    if (activeView === 'backups') {
      loadBackupData()
    }
  }, [activeView])

  // Backup data - Initially empty, populated from API
  const [backupHistory, setBackupHistory] = useState([])
  const [systemStatus, setSystemStatus] = useState({
    lastBackup: null,
    nextBackup: null,
    serverSpace: { used: 0, total: 22, unit: 'GB' },
    cloudSpace: { used: 0, total: 5, unit: 'GB' },
    archiveCount: 0
  })

  const handleCreateClinic = async () => {
    if (!newClinic.name || !newClinic.country) {
      alert('Nombre y pa√≠s son obligatorios')
      return
    }

    try {
      const response = await apiFetch('/api/clinics', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name: newClinic.name,
          phone: newClinic.phone,
          email: newClinic.email || null,
          address: newClinic.address || null
        }),
      })

      if (response.ok) {
        const clinic = await response.json()
        setAllClinics([...allClinics, clinic])
        setNewClinic({ name: '', country: '', phone: '', address: '' })
        setShowCreateClinic(false)
        alert('Cl√≠nica creada exitosamente')
      } else {
        const error = await response.json()
        alert(`Error: ${error.error}`)
      }
    } catch (error) {
      console.error('Error creating clinic:', error)
      alert('Error al crear la cl√≠nica')
    }
  }

  const handleCreateUser = async () => {
    if (!newUser.email || !newUser.role) {
      alert('Email y rol son obligatorios')
      return
    }

    try {
      const response = await apiFetch('/api/users', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          email: newUser.email,
          password: 'temp123', // Temporary password
          role: newUser.role.toLowerCase(),
          clinicId: newUser.role === 'clinic' ? parseInt(newUser.clinic) : null
        }),
      })

      if (response.ok) {
        const user = await response.json()
        setAllUsers([...allUsers, {
          id: user.id,
          name: user.email.split('@')[0],
          email: user.email,
          role: user.role,
          organization: user.clinicId ? 'Cl√≠nica' : 'Lucv√°n',
          createdAt: new Date().toISOString().split('T')[0]
        }])
        setNewUser({ name: '', email: '', role: 'clinic', clinic: '' })
        alert('Usuario creado exitosamente')
      } else {
        const error = await response.json()
        alert(`Error: ${error.error}`)
      }
    } catch (error) {
      console.error('Error creating user:', error)
      alert('Error al crear el usuario')
    }
  }

  const handleLogout = () => {
    logout()
    navigate('/login')
  }

  const handleExportReport = () => {
    let csvContent = ''
    let filename = ''

    if (selectedReport === 'patients') {
      // Generar reporte CSV de pacientes con BOM para UTF-8
      csvContent = [
        ['ID', 'Nombre', 'Telefono', 'Email', 'Fecha de Nacimiento', 'Clinica', 'Notas'],
        ...allPatients.map(p => [
          p.id,
          p.name,
          p.phone,
          p.email,
          p.birthDate,
          p.clinic,
          `"${(p.notes || '').replace(/"/g, '""')}"` // Escapar comillas en notas
        ])
      ].map(row => row.join(',')).join('\n')
      filename = `reporte-pacientes-${new Date().toISOString().split('T')[0]}.csv`
    } else if (selectedReport === 'tickets') {
      // Generar reporte CSV de tickets con BOM para UTF-8
      csvContent = [
        ['ID Ticket', 'Paciente', 'Clinica', 'Doctor', 'Tipo de Plantilla', 'Arcada', 'Estado', 'Fecha de Creacion', 'Ultima Actualizacion'],
        ...allTickets.map(t => [
          t.id,
          t.patientName,
          t.clinicName,
          t.doctorName,
          t.templateType,
          t.arch,
          t.status,
          new Date(t.createdDate).toLocaleDateString('es-ES'),
          new Date(t.date).toLocaleDateString('es-ES')
        ])
      ].map(row => row.join(',')).join('\n')
      filename = `reporte-tickets-${new Date().toISOString().split('T')[0]}.csv`
    } else if (selectedReport === 'users') {
      csvContent = [
        ['ID', 'Nombre', 'Email', 'Rol', 'Organizaci√≥n', 'Fecha de Creaci√≥n'],
        ...allUsers.map(u => [u.id, u.name, u.email, u.role, u.organization, new Date(u.createdAt).toLocaleDateString('es-ES')])
      ].map(row => row.join(',')).join('\n')
      filename = `reporte-usuarios-${new Date().toISOString().split('T')[0]}.csv`
    }

    // Agregar BOM (Byte Order Mark) para que Excel reconozca UTF-8
    const BOM = '\uFEFF'
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' })
    const url = window.URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = filename
    a.click()
    window.URL.revokeObjectURL(url)
  }

  const handleManualBackup = async () => {
    setBackupInProgress(true)
    try {
      const response = await apiFetch('/api/backups/manual', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      
      if (response.ok) {
        const data = await response.json()
        alert('Backup manual iniciado. El proceso se ejecutar√° en segundo plano.')
        // Reload backup history
        loadBackupData()
      } else {
        const error = await response.json()
        alert('Error al crear backup: ' + (error.error || 'Error desconocido'))
      }
    } catch (err) {
      console.error('Error creating backup:', err)
      alert('Error al crear backup manual')
    } finally {
      setBackupInProgress(false)
    }
  }

  const handleDownloadBackup = (backupId) => {
    // En producci√≥n: descargar desde Firebase/servidor
    alert(`Descargando backup ${backupId}... (Funcionalidad se implementar√° con Firebase)`)
  }

  const handleRestoreBackup = (backupId) => {
    const confirmed = window.confirm(
      '‚ö†Ô∏è ADVERTENCIA: Restaurar un backup sobrescribir√° todos los datos actuales del sistema. ¬øEst√°s seguro de continuar?'
    )
    
    if (confirmed) {
      alert(`Restaurando backup ${backupId}... (Funcionalidad se implementar√° con Firebase)`)
    }
  }

  return (
    <div className="min-h-screen bg-[#F4F6F8]">
      <LucvanHeader
        title="Panel de Administraci√≥n"
        user={currentUser}
        onLogout={handleLogout}
        showBack={activeView !== 'home'}
        onBack={() => setActiveView('home')}
      />

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {activeView === 'home' && (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <button
              onClick={() => navigate('/admin/users')}
              className="bg-white p-8 rounded-xl shadow-md hover:shadow-lg transition transform hover:scale-105 border border-gray-100"
            >
              <div className="text-5xl mb-4">üë•</div>
              <h2 className="text-xl font-bold text-blue-900 mb-2">Ver Usuarios</h2>
              <p className="text-gray-600">Gestionar usuarios del sistema</p>
            </button>

            <button
              onClick={() => navigate('/clinic')}
              className="bg-white p-8 rounded-xl shadow-md hover:shadow-lg transition transform hover:scale-105 border border-gray-100"
            >
              <div className="text-5xl mb-4">üè•</div>
              <h2 className="text-xl font-bold text-blue-900 mb-2">Ver Cl√≠nicas</h2>
              <p className="text-gray-600">Acceder al m√≥dulo de cl√≠nicas</p>
            </button>

            <button
              onClick={() => navigate('/production')}
              className="bg-white p-8 rounded-xl shadow-md hover:shadow-lg transition transform hover:scale-105 border border-gray-100"
            >
              <div className="text-5xl mb-4">üî®</div>
              <h2 className="text-xl font-bold text-blue-900 mb-2">Producci√≥n</h2>
              <p className="text-gray-600">Acceder al m√≥dulo de producci√≥n</p>
            </button>

            <button
              onClick={() => setActiveView('reports')}
              className="bg-white p-8 rounded-xl shadow-md hover:shadow-lg transition transform hover:scale-105 border border-gray-100"
            >
              <div className="text-5xl mb-4">üìä</div>
              <h2 className="text-xl font-bold text-blue-900 mb-2">Reportes</h2>
              <p className="text-gray-600">Descargar reportes del sistema</p>
            </button>

            <button
              onClick={() => setActiveView('backups')}
              className="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition transform hover:scale-105"
            >
              <div className="text-5xl mb-4">üíæ</div>
              <h2 className="text-xl font-bold text-blue-900 mb-2">Backups</h2>
              <p className="text-gray-600">Gestionar copias de seguridad</p>
            </button>
          </div>
        )}

        {activeView === 'users' && (
          <div className="bg-white rounded-xl shadow-lg p-6">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold">Gesti√≥n de Usuarios</h2>
              <button
                onClick={() => setActiveView('home')}
                className="px-4 py-2 bg-white border-2 border-[#0066A4] text-[#003C63] rounded-full hover:bg-[#F4F6F8] font-semibold transition-all"
              >
                ‚Üê Volver
              </button>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="border border-gray-200 rounded-lg p-6">
                <h3 className="text-lg font-semibold text-gray-900 mb-4">Crear Usuario</h3>
                <div className="space-y-4">
                  <input
                    type="text"
                    placeholder="Nombre"
                    value={newUser.name}
                    onChange={(e) => setNewUser({ ...newUser, name: e.target.value })}
                    className="w-full px-4 py-2.5 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-[#0066A4] focus:border-[#0066A4]"
                  />
                  <input
                    type="email"
                    placeholder="Email"
                    value={newUser.email}
                    onChange={(e) => setNewUser({ ...newUser, email: e.target.value })}
                    className="w-full px-4 py-2.5 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-[#0066A4] focus:border-[#0066A4]"
                  />
                  <select
                    value={newUser.role}
                    onChange={(e) => {
                      const roleValue = e.target.value
                      setNewUser({ ...newUser, role: roleValue, clinic: roleValue === 'clinic' ? newUser.clinic : '' })
                    }}
                    className="w-full px-4 py-2.5 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-[#0066A4] focus:border-[#0066A4]"
                  >
                    <option value="clinic">Cl√≠nica</option>
                    <option value="production">Producci√≥n</option>
                    <option value="admin">Admin</option>
                  </select>

                  {newUser.role === 'clinic' && (
                    <div className="flex items-center gap-2">
                      <select
                        value={newUser.clinic}
                        onChange={(e) => setNewUser({ ...newUser, clinic: e.target.value })}
                        className="flex-1 px-4 py-2.5 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-[#0066A4] focus:border-[#0066A4]"
                      >
                        <option value="">Seleccionar Cl√≠nica</option>
                        {allPatients
                          .map((p) => p.clinic)
                          .filter((v, i, a) => a.indexOf(v) === i)
                          .map((c) => (
                            <option key={c} value={c}>
                              {c}
                            </option>
                          ))}
                      </select>
                      <button
                        type="button"
                        onClick={() => setShowCreateClinic(true)}
                        className="px-4 py-2 bg-[#F5C400] text-[#003C63] rounded-full font-bold hover:bg-[#ffd933] transition shadow-[0_12px_24px_-10px_rgba(0,60,99,0.25)]"
                      >
                        + Cl√≠nica
                      </button>
                    </div>
                  )}

                  <button 
                    className="w-full px-4 py-2 bg-[#F5C400] text-[#003C63] rounded-full font-bold hover:bg-[#ffd933] transition"
                    onClick={handleCreateUser}
                  >
                    Crear Usuario
                  </button>
                </div>
              </div>

              {showCreateClinic && (
                <div className="border border-gray-200 rounded-lg p-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">Crear Cl√≠nica</h3>
                  <div className="space-y-4">
                    <input
                      type="text"
                      placeholder="Nombre de la Cl√≠nica"
                      value={newClinic.name}
                      onChange={(e) => setNewClinic({ ...newClinic, name: e.target.value })}
                      className="w-full px-4 py-2.5 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-[#0066A4] focus:border-[#0066A4]"
                    />
                    <select
                      required
                      value={newClinic.country}
                      onChange={(e) => setNewClinic({ ...newClinic, country: e.target.value })}
                      className="w-full px-4 py-2.5 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-[#0066A4] focus:border-[#0066A4]"
                    >
                      <option value="">Seleccionar Pa√≠s (obligatorio)</option>
                      {AMERICAS_COUNTRIES.map((country) => (
                        <option key={country} value={country}>
                          {country}
                        </option>
                      ))}
                    </select>
                    <input
                      type="tel"
                      inputMode="numeric"
                      pattern="[0-9 ]*"
                      placeholder="Tel√©fono de contacto"
                      value={newClinic.phone}
                      onChange={(e) => setNewClinic({ ...newClinic, phone: e.target.value.replace(/[^0-9 ]/g, '') })}
                      className="w-full px-4 py-2.5 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-[#0066A4] focus:border-[#0066A4]"
                    />
                    <textarea
                      rows="3"
                      placeholder="Direcci√≥n exacta de la cl√≠nica"
                      value={newClinic.address}
                      onChange={(e) => setNewClinic({ ...newClinic, address: e.target.value })}
                      className="w-full px-4 py-2.5 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-[#0066A4] focus:border-[#0066A4]"
                    />
                    <div className="flex gap-2">
                      <button
                        type="button"
                        className="flex-1 px-4 py-2 bg-[#F5C400] text-[#003C63] rounded-full font-bold hover:bg-[#ffd933] transition"
                        onClick={handleCreateClinic}
                      >
                        Guardar Cl√≠nica
                      </button>
                      <button
                        type="button"
                        onClick={() => setShowCreateClinic(false)}
                        className="flex-1 px-4 py-2 bg-white border-2 border-[#0066A4] text-[#003C63] rounded-full hover:bg-[#F4F6F8]"
                      >
                        Cancelar
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {activeView === 'backups' && (
          <div className="bg-white rounded-xl shadow-lg p-6">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold text-[#003C63]">Gesti√≥n de Backups</h2>
              <button
                onClick={handleManualBackup}
                disabled={backupInProgress}
                className={`px-6 py-2 rounded-full font-bold transition-colors duration-200 shadow-lg ${
                  backupInProgress
                    ? 'bg-gray-400 text-gray-200 cursor-not-allowed'
                    : 'bg-[#F5C400] text-[#003C63] hover:bg-[#ffd933]'
                }`}
              >
                {backupInProgress ? 'Procesando...' : 'Crear Backup Manual'}
              </button>
            </div>

            <div className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                  <p className="text-sm text-gray-600 mb-1">√öltimo Backup</p>
                  <p className="text-lg font-semibold text-gray-800">
                    {systemStatus.lastBackup ? new Date(systemStatus.lastBackup).toLocaleDateString('es-ES') : 'Sin datos'}
                  </p>
                  {systemStatus.lastBackup && (
                    <p className="text-xs text-gray-500">
                      {new Date(systemStatus.lastBackup).toLocaleTimeString('es-ES')}
                    </p>
                  )}
                </div>
                <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                  <p className="text-sm text-gray-600 mb-1">Pr√≥ximo Backup</p>
                  <p className="text-lg font-semibold text-gray-800">
                    {systemStatus.nextBackup ? new Date(systemStatus.nextBackup).toLocaleDateString('es-ES') : 'Domingos 3:00 AM'}
                  </p>
                  {systemStatus.nextBackup && (
                    <p className="text-xs text-gray-500">
                      {new Date(systemStatus.nextBackup).toLocaleTimeString('es-ES')}
                    </p>
                  )}
                </div>
                <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                  <p className="text-sm text-gray-600 mb-1">Espacio Servidor</p>
                  <p className="text-lg font-semibold text-gray-800">
                    {systemStatus.serverSpace.used} / {systemStatus.serverSpace.total} GB
                  </p>
                  <div className="w-full bg-gray-200 rounded-full h-2 mt-2">
                    <div
                      className="bg-yellow-500 h-2 rounded-full"
                      style={{ width: `${(systemStatus.serverSpace.used / systemStatus.serverSpace.total) * 100}%` }}
                    ></div>
                  </div>
                </div>
                <div className="bg-purple-50 p-4 rounded-lg border border-purple-200">
                  <p className="text-sm text-gray-600 mb-1">Espacio Cloud</p>
                  <p className="text-lg font-semibold text-gray-800">
                    {systemStatus.cloudSpace.used} / {systemStatus.cloudSpace.total} GB
                  </p>
                  <div className="w-full bg-gray-200 rounded-full h-2 mt-2">
                    <div
                      className="bg-purple-500 h-2 rounded-full"
                      style={{ width: `${(systemStatus.cloudSpace.used / systemStatus.cloudSpace.total) * 100}%` }}
                    ></div>
                  </div>
                </div>
              </div>

              <div className="border border-gray-200 rounded-lg p-6 bg-gray-50">
                <h3 className="text-lg font-semibold mb-4 text-gray-800">Historial de Backups</h3>
                <div className="overflow-x-auto">
                  <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead className="bg-gray-100">
                      <tr>
                        <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">ID</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Tipo</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Fecha</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Tama√±o</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Chunks</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Estado</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      {backupHistory.length === 0 ? (
                        <tr>
                          <td colSpan="7" className="px-4 py-8 text-center text-gray-500">
                            No hay backups registrados. Crea un backup manual para comenzar.
                          </td>
                        </tr>
                      ) : backupHistory.map((backup, index) => (
                        <tr key={backup.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                          <td className="px-4 py-3 text-sm text-gray-800">{backup.id}</td>
                          <td className="px-4 py-3 text-sm">
                            <span
                              className={`px-2 py-1 rounded-full text-xs font-medium ${
                                backup.type === 'Autom√°tico' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'
                              }`}
                            >
                              {backup.type}
                            </span>
                          </td>
                          <td className="px-4 py-3 text-sm text-gray-800">
                            {new Date(backup.date).toLocaleDateString('es-ES')}{' '}
                            {new Date(backup.date).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}
                          </td>
                          <td className="px-4 py-3 text-sm text-gray-800">{backup.size}</td>
                          <td className="px-4 py-3 text-sm text-gray-600">{backup.chunks}</td>
                          <td className="px-4 py-3 text-sm">
                            <span
                              className={`px-2 py-1 rounded-full text-xs font-medium ${
                                backup.status === 'completed' || backup.status === 'Completado'
                                  ? 'bg-green-100 text-green-800'
                                  : backup.status === 'in_progress' || backup.status === 'En Progreso'
                                  ? 'bg-yellow-100 text-yellow-800'
                                  : 'bg-red-100 text-red-800'
                              }`}
                            >
                              {backup.status === 'completed' ? 'Completado' : backup.status === 'in_progress' ? 'En Progreso' : backup.status}
                            </span>
                          </td>
                          <td className="px-4 py-3 text-sm">
                            <div className="flex gap-2">
                              <button
                                onClick={() => handleDownloadBackup(backup.id)}
                                className="text-blue-600 hover:text-blue-800 font-medium"
                                title="Descargar backup"
                              >
                                Descargar
                              </button>
                              <button
                                onClick={() => handleRestoreBackup(backup.id)}
                                className="text-green-600 hover:text-green-800 font-medium"
                                title="Restaurar backup"
                              >
                                Restaurar
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              <div className="text-sm text-gray-600 bg-blue-50 p-4 rounded-lg border border-blue-200">
                <h4 className="font-semibold text-gray-800 mb-2">‚ÑπÔ∏è Informaci√≥n del Sistema de Backups</h4>
                <p className="mb-2">
                  <strong>Backups Autom√°ticos:</strong> Se ejecutan semanalmente (domingos a las 3:00 AM).
                  Los backups grandes se dividen en chunks de ~900MB que se suben durante varios d√≠as consecutivos para no exceder los l√≠mites de transferencia.
                </p>
                <p className="mb-2">
                  <strong>Backups Manuales:</strong> Puedes crear backups manuales en cualquier momento desde este panel.
                  El sistema notificar√° cuando el proceso finalice.
                </p>
                <p>
                  <strong>Archivos Archivados:</strong> {systemStatus.archiveCount} archivos antiguos (mayores a 12 meses) est√°n almacenados en la nube para liberar espacio en el servidor.
                </p>
              </div>
          </div>
        )}

        {activeView === 'reports' && (
          <div className="bg-white rounded-xl shadow-lg p-6">
            <h2 className="text-2xl font-bold text-[#003C63] mb-6">Reportes del Sistema</h2>
            <div className="space-y-6">
              <div className="border border-gray-200 rounded-lg p-6 bg-gray-50">
                <h3 className="text-lg font-semibold text-gray-900 mb-4">Selecciona el Tipo de Reporte</h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <button
                      onClick={() => setSelectedReport('patients')}
                      className={`p-4 rounded-lg border-2 transition ${
                        selectedReport === 'patients'
                          ? 'border-green-500 bg-green-50'
                          : 'border-gray-300 bg-white hover:border-gray-400'
                      }`}
                    >
                      <div className="flex items-center gap-3">
                        <div className="text-3xl">üìã</div>
                        <div className="text-left">
                          <h4 className="font-semibold text-gray-900">Reporte de Pacientes</h4>
                          <p className="text-sm text-gray-600">{allPatients.length} registros</p>
                        </div>
                      </div>
                    </button>

                    <button
                      onClick={() => setSelectedReport('tickets')}
                      className={`p-4 rounded-lg border-2 transition ${
                        selectedReport === 'tickets'
                          ? 'border-blue-500 bg-blue-50'
                          : 'border-gray-300 bg-white hover:border-gray-400'
                      }`}
                    >
                      <div className="flex items-center gap-3">
                        <div className="text-3xl">üé´</div>
                        <div className="text-left">
                          <h4 className="font-semibold text-gray-900">Reporte de Solicitudes</h4>
                          <p className="text-sm text-gray-600">{allTickets.length} registros</p>
                        </div>
                      </div>
                    </button>

                    <button
                      onClick={() => setSelectedReport('users')}
                      className={`p-4 rounded-lg border-2 transition ${
                        selectedReport === 'users'
                          ? 'border-purple-500 bg-purple-50'
                          : 'border-gray-300 bg-white hover:border-gray-400'
                      }`}
                    >
                      <div className="flex items-center gap-3">
                        <div className="text-3xl">üë§</div>
                        <div className="text-left">
                          <h4 className="font-semibold text-gray-900">Reporte de Usuarios</h4>
                          <p className="text-sm text-gray-600">{allUsers.length} registros</p>
                        </div>
                      </div>
                    </button>
                  </div>
                </div>

                {selectedReport === 'patients' && (
                  <div className="border border-gray-200 rounded-lg p-6">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-lg font-semibold text-gray-900">Vista Previa - Reporte de Pacientes</h3>
                      <button
                        onClick={handleExportReport}
                        className="px-6 py-2.5 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition flex items-center gap-2"
                      >
                        üì• Descargar Reporte
                      </button>
                    </div>
                    <p className="text-sm text-gray-600 mb-4">
                      Lista completa de pacientes con informaci√≥n de contacto y cl√≠nica asignada.
                    </p>
                    <div className="overflow-x-auto">
                      <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tel√©fono</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cl√≠nica</th>
                          </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                          {allPatients.slice(0, 20).map((patient, index) => (
                            <tr key={patient.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                              <td className="px-4 py-3 text-sm text-gray-900">{patient.name}</td>
                              <td className="px-4 py-3 text-sm text-gray-600">{patient.email}</td>
                              <td className="px-4 py-3 text-sm text-gray-600">{patient.phone}</td>
                              <td className="px-4 py-3 text-sm text-gray-900 font-medium">{patient.clinic}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    {allPatients.length > 20 && (
                      <p className="text-sm text-gray-500 mt-3 text-center">
                        Mostrando 20 de {allPatients.length} pacientes. Descarga el reporte completo para ver todos.
                      </p>
                    )}
                  </div>
                )}

                {selectedReport === 'tickets' && (
                  <div className="border border-gray-200 rounded-lg p-6">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-lg font-semibold text-gray-900">Vista Previa - Reporte de Solicitudes</h3>
                      <button
                        onClick={handleExportReport}
                        className="px-6 py-2.5 bg-yellow-500 text-blue-950 rounded-lg font-semibold hover:bg-yellow-600 transition flex items-center gap-2"
                      >
                        üì• Descargar Reporte
                      </button>
                    </div>
                    <p className="text-sm text-gray-600 mb-4">
                      Historial completo de solicitudes con informaci√≥n del paciente, cl√≠nica, estado y fechas.
                    </p>
                    <div className="overflow-x-auto">
                      <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Paciente</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cl√≠nica</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha Creaci√≥n</th>
                          </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                          {allTickets.slice(0, 20).map((ticket, index) => (
                            <tr key={ticket.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                              <td className="px-4 py-3 text-sm text-gray-900">{ticket.patientName}</td>
                              <td className="px-4 py-3 text-sm text-gray-600">{ticket.clinicName}</td>
                              <td className="px-4 py-3 text-sm text-gray-600">{ticket.templateType}</td>
                              <td className="px-4 py-3 text-sm">
                                <span
                                  className={`px-2 py-1 rounded-full text-xs font-semibold ${
                                    ticket.status === 'Pendiente'
                                      ? 'bg-yellow-100 text-yellow-800'
                                      : ticket.status === 'En Producci√≥n'
                                      ? 'bg-blue-100 text-blue-800'
                                      : ticket.status === 'Lista para Entregar'
                                      ? 'bg-purple-100 text-purple-800'
                                      : 'bg-green-100 text-green-800'
                                  }`}
                                >
                                  {ticket.status}
                                </span>
                              </td>
                              <td className="px-4 py-3 text-sm text-gray-600">{new Date(ticket.createdDate).toLocaleDateString('es-ES')}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    {allTickets.length > 20 && (
                      <p className="text-sm text-gray-500 mt-3 text-center">
                        Mostrando 20 de {allTickets.length} solicitudes. Descarga el reporte completo para ver todas.
                      </p>
                    )}
                  </div>
                )}

                {selectedReport === 'users' && (
                  <div className="border border-gray-200 rounded-lg p-6">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-lg font-semibold text-gray-900">Vista Previa - Reporte de Usuarios</h3>
                      <button
                        onClick={handleExportReport}
                        className="px-6 py-2.5 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition flex items-center gap-2"
                      >
                        üì• Descargar Reporte
                      </button>
                    </div>
                    <p className="text-sm text-gray-600 mb-4">
                      Usuarios del sistema, su rol y organizaci√≥n asociada.
                    </p>
                    <div className="overflow-x-auto">
                      <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rol</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Organizaci√≥n</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Creado</th>
                          </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                          {allUsers.slice(0, 20).map((u, index) => (
                            <tr key={u.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                              <td className="px-4 py-3 text-sm text-gray-900">{u.name}</td>
                              <td className="px-4 py-3 text-sm text-gray-600">{u.email}</td>
                              <td className="px-4 py-3 text-sm text-gray-600">{u.role}</td>
                              <td className="px-4 py-3 text-sm text-gray-900 font-medium">{u.organization}</td>
                              <td className="px-4 py-3 text-sm text-gray-600">{new Date(u.createdAt).toLocaleDateString('es-ES')}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    {allUsers.length > 20 && (
                      <p className="text-sm text-gray-500 mt-3 text-center">
                        Mostrando 20 de {allUsers.length} usuarios. Descarga el reporte completo para ver todos.
                      </p>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}
      </main>
    </div>
  )
}
